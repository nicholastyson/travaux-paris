<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projets — Travaux & Équipements Publics — Paris</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #F0F1F3;
      --surface: #FFFFFF;
      --border: #D6DAE0;
      --text: #061F33;
      --text-muted: #5C6670;
      --accent: #061F33;
      --accent-light: #0A3356;
      --card-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    [data-theme="dark"] {
      --bg: #081824;
      --surface: #0E2236;
      --border: #1B3A55;
      --text: #E8ECF0;
      --text-muted: #8BA3BB;
      --accent: #FFD437;
      --accent-light: #FFE066;
      --card-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    body {
      font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header — always Paris navy */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: #061F33;
      border-bottom: 1px solid #0A3356;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header h1 {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.01em;
      color: #fff;
    }
    header h1 span { color: #FFD437; }
    nav {
      display: flex;
      gap: 4px;
    }
    nav a {
      font-size: 13px;
      padding: 5px 14px;
      border-radius: 6px;
      text-decoration: none;
      color: rgba(255,255,255,0.7);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.15s;
    }
    nav a:hover { border-color: rgba(255,255,255,0.4); color: #fff; }
    nav a.active {
      background: #FFD437;
      border-color: #FFD437;
      color: #061F33;
      font-weight: 600;
    }
    .record-count {
      font-size: 13px;
      color: rgba(255,255,255,0.8);
      background: rgba(255,255,255,0.12);
      padding: 4px 12px;
      border-radius: 20px;
    }
    .theme-toggle {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: rgba(255,255,255,0.8);
      cursor: pointer;
      padding: 5px 8px;
      display: flex;
      align-items: center;
      transition: all 0.15s;
    }
    .theme-toggle:hover { background: rgba(255,255,255,0.2); color: #fff; }
    .theme-toggle svg { width: 16px; height: 16px; }
    .icon-sun { display: none; }
    [data-theme="dark"] .icon-sun { display: block; }
    [data-theme="dark"] .icon-moon { display: none; }

    /* Filter bar */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 14px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      align-items: flex-end;
    }
    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .filter-item label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    select, input[type="text"] {
      padding: 7px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      outline: none;
      min-width: 150px;
    }
    input[type="text"] { min-width: 180px; }
    select:focus, input:focus { border-color: var(--accent); }
    .btn-reset {
      padding: 7px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
      align-self: flex-end;
    }
    .btn-reset:hover { border-color: var(--accent); color: var(--text); }

    /* Card grid */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
      padding: 24px;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: border-color 0.15s, box-shadow 0.15s;
      box-shadow: var(--card-shadow);
    }
    .card:hover { border-color: var(--accent); }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.3;
    }
    .card-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .card-rows {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }
    .card-row {
      display: flex;
      gap: 8px;
    }
    .card-label {
      color: var(--text-muted);
      min-width: 80px;
      flex-shrink: 0;
      font-size: 12px;
    }
    .card-value {
      font-size: 13px;
    }
    .card-desc {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Card images */
    .card-images {
      display: flex;
      gap: 6px;
      margin: -18px -18px 0 -18px;
      padding: 0;
      border-radius: 9px 9px 0 0;
      overflow: hidden;
    }
    .card-images > div {
      flex: 1;
      height: 140px;
      min-width: 0;
    }
    .card-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
    }
    .card-placeholder svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
    }
    .card-placeholder .sector-label {
      font-size: 11px;
      font-weight: 600;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: absolute;
      bottom: 8px;
      left: 0;
      right: 0;
      text-align: center;
    }
    .card-satellite img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .card-satellite .no-loc {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      color: var(--text-muted);
      font-size: 11px;
    }

    /* Empty state */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      font-size: 15px;
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s;
    }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 600px) {
      .card-grid { grid-template-columns: 1fr; padding: 14px; }
      .filter-bar { padding: 10px 14px; }
      select, input[type="text"] { min-width: 120px; }
    }
  </style>
</head>
<body>
  <script>if(localStorage.getItem('paris-theme')==='dark')document.documentElement.setAttribute('data-theme','dark');</script>
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
  </div>

  <header>
    <div class="header-left">
      <h1>Travaux & <span>Équipements Publics</span> — Paris</h1>
      <nav>
        <a href="index.html">Carte</a>
        <a href="projects.html" class="active">Projets</a>
      </nav>
    </div>
    <div class="header-right">
      <div class="record-count" id="recordCount">Chargement...</div>
      <button class="theme-toggle" id="themeToggle" title="Changer de thème">
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
    </div>
  </header>

  <div class="filter-bar">
    <div class="filter-item">
      <label>Secteur</label>
      <select id="filterSecteur"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Type d'équipement</label>
      <select id="filterType"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Type de travaux</label>
      <select id="filterConstruction"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Arrondissement</label>
      <select id="filterArrond"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Service</label>
      <select id="filterService"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Année</label>
      <select id="filterAnnee"><option value="">Toutes</option></select>
    </div>
    <div class="filter-item">
      <label>Recherche</label>
      <input type="text" id="filterSearch" placeholder="Nom, adresse...">
    </div>
    <button class="btn-reset" id="btnReset">Réinitialiser</button>
  </div>

  <div class="card-grid" id="cardGrid"></div>

  <script src="shared.js"></script>
  <script>
    let allRecords = [];
    let filteredRecords = [];

    function populateFilters() {
      const arrondissements = [...new Set(allRecords.map(r => r._arrondissement).filter(Boolean))]
        .sort((a, b) => parseInt(a) - parseInt(b));

      const sets = {
        filterSecteur: [...new Set(allRecords.map(r => r.secteur).filter(Boolean))].sort(),
        filterType: [...new Set(allRecords.map(r => r.type_equipement).filter(Boolean))].sort(),
        filterConstruction: [...new Set(allRecords.map(r => r._constructionGroup).filter(Boolean))].sort(),
        filterService: [...new Set(allRecords.map(r => r._service).filter(Boolean))].sort(),
        filterAnnee: [...new Set(allRecords.map(r => r.annee_livraison).filter(Boolean))].sort(),
        filterArrond: arrondissements,
      };

      for (const [id, values] of Object.entries(sets)) {
        const sel = document.getElementById(id);
        values.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
      }
    }

    function applyFilters() {
      const secteur = document.getElementById('filterSecteur').value;
      const type = document.getElementById('filterType').value;
      const construction = document.getElementById('filterConstruction').value;
      const service = document.getElementById('filterService').value;
      const annee = document.getElementById('filterAnnee').value;
      const arrond = document.getElementById('filterArrond').value;
      const search = document.getElementById('filterSearch').value.toLowerCase();

      filteredRecords = allRecords.filter(r => {
        if (secteur && r.secteur !== secteur) return false;
        if (type && r.type_equipement !== type) return false;
        if (construction && r._constructionGroup !== construction) return false;
        if (service && r._service !== service) return false;
        if (annee && r.annee_livraison !== annee) return false;
        if (arrond && r._arrondissement !== arrond) return false;
        if (search) {
          const hay = [r.equipement, r.adresse, r.description, r.type_equipement, r.secteur]
            .filter(Boolean).join(' ').toLowerCase();
          if (!hay.includes(search)) return false;
        }
        return true;
      });

      renderCards();
      document.getElementById('recordCount').textContent = `${filteredRecords.length} / ${allRecords.length} projets`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderCards() {
      const grid = document.getElementById('cardGrid');

      if (filteredRecords.length === 0) {
        grid.innerHTML = '<div class="empty-state">Aucun projet ne correspond aux filtres sélectionnés.</div>';
        return;
      }

      const buildingSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M3 21V7l9-4 9 4v14H3zm2-2h5v-4h4v4h5V8.1l-7-3.12L5 8.1V19zm2-6h2v2H7v-2zm0-4h2v2H7V9zm4 4h2v2h-2v-2zm0-4h2v2h-2V9zm4 4h2v2h-2v-2zm0-4h2v2h-2V9z"/></svg>`;

      grid.innerHTML = filteredRecords.map(r => {
        const color = getColor(r.secteur);
        const budget = formatBudget(r);
        const addr = r.adresse || '—';
        const arrond = r._arrondissement ? ` (${r._arrondissement})` : '';
        const desc = r.description ? escapeHtml(r.description) : '';
        const satUrl = getSatelliteUrl(r);

        const satHtml = satUrl
          ? `<img src="${satUrl}" alt="Vue satellite" loading="lazy">`
          : `<div class="no-loc">Pas de localisation</div>`;

        return `
          <div class="card">
            <div class="card-images">
              <div class="card-placeholder" style="background:linear-gradient(135deg, ${color}, ${color}99)">
                ${buildingSvg}
                <span class="sector-label">${escapeHtml(r.secteur) || ''}</span>
              </div>
              <div class="card-satellite">${satHtml}</div>
            </div>
            <div class="card-header">
              <div class="card-title">${escapeHtml(r.equipement) || '—'}</div>
              <span class="card-badge" style="background:${color}22;color:${color}">${escapeHtml(r.secteur) || '—'}</span>
            </div>
            <div class="card-rows">
              <div class="card-row"><span class="card-label">Adresse</span><span class="card-value">${escapeHtml(addr)}${arrond}</span></div>
              <div class="card-row"><span class="card-label">Travaux</span><span class="card-value">${escapeHtml(r._constructionGroup) || '—'}</span></div>
              <div class="card-row"><span class="card-label">Budget</span><span class="card-value">${budget}</span></div>
              <div class="card-row"><span class="card-label">Livraison</span><span class="card-value">${r.annee_livraison || '—'}</span></div>
            </div>
            ${desc ? `<div class="card-desc">${desc}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // Filter event listeners
    ['filterSecteur', 'filterType', 'filterConstruction', 'filterService', 'filterAnnee', 'filterArrond'].forEach(id => {
      document.getElementById(id).addEventListener('change', applyFilters);
    });
    document.getElementById('filterSearch').addEventListener('input', applyFilters);
    document.getElementById('btnReset').addEventListener('click', () => {
      ['filterSecteur', 'filterType', 'filterConstruction', 'filterService', 'filterAnnee', 'filterArrond'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('filterSearch').value = '';
      applyFilters();
    });

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('paris-theme', 'light');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('paris-theme', 'dark');
      }
    });

    // Init
    (async () => {
      allRecords = await fetchAll();
      populateFilters();
      applyFilters();
      document.getElementById('loading').classList.add('hidden');
    })();
  </script>
</body>
</html>
