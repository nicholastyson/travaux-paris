<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bâtiments — Travaux & Équipements Publics — Paris</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #F0F1F3;
      --surface: #FFFFFF;
      --border: #D6DAE0;
      --text: #061F33;
      --text-muted: #5C6670;
      --accent: #061F33;
      --accent-light: #0A3356;
      --card-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    [data-theme="dark"] {
      --bg: #081824;
      --surface: #0E2236;
      --border: #1B3A55;
      --text: #E8ECF0;
      --text-muted: #8BA3BB;
      --accent: #FFD437;
      --accent-light: #FFE066;
      --card-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    body {
      font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header — always Paris navy */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: #061F33;
      border-bottom: 1px solid #0A3356;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header h1 {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.01em;
      color: #fff;
    }
    header h1 span { color: #FFD437; }
    nav {
      display: flex;
      gap: 4px;
    }
    nav a {
      font-size: 13px;
      padding: 5px 14px;
      border-radius: 6px;
      text-decoration: none;
      color: rgba(255,255,255,0.7);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.15s;
    }
    nav a:hover { border-color: rgba(255,255,255,0.4); color: #fff; }
    nav a.active {
      background: #FFD437;
      border-color: #FFD437;
      color: #061F33;
      font-weight: 600;
    }
    .record-count {
      font-size: 13px;
      color: rgba(255,255,255,0.8);
      background: rgba(255,255,255,0.12);
      padding: 4px 12px;
      border-radius: 20px;
    }
    .theme-toggle {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: rgba(255,255,255,0.8);
      cursor: pointer;
      padding: 5px 8px;
      display: flex;
      align-items: center;
      transition: all 0.15s;
    }
    .theme-toggle:hover { background: rgba(255,255,255,0.2); color: #fff; }
    .theme-toggle svg { width: 16px; height: 16px; }
    .icon-sun { display: none; }
    [data-theme="dark"] .icon-sun { display: block; }
    [data-theme="dark"] .icon-moon { display: none; }

    /* Filter bar */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 14px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      align-items: flex-end;
    }
    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .filter-item label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    select, input[type="text"] {
      padding: 7px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      outline: none;
      min-width: 150px;
    }
    input[type="text"] { min-width: 180px; }
    select:focus, input:focus { border-color: var(--accent); }
    .btn-reset {
      padding: 7px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
      align-self: flex-end;
    }
    .btn-reset:hover { border-color: var(--accent); color: var(--text); }

    /* Card grid */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 16px;
      padding: 24px;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      transition: border-color 0.15s, box-shadow 0.15s;
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }
    .card:hover { border-color: var(--accent); }

    /* Card images */
    .card-images {
      display: flex;
      gap: 0;
      height: 140px;
      overflow: hidden;
    }
    .card-images > div {
      flex: 1;
      height: 140px;
      min-width: 0;
    }
    .card-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
    }
    .card-placeholder svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
    }
    .card-placeholder .sector-label {
      font-size: 11px;
      font-weight: 600;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: absolute;
      bottom: 8px;
      left: 0;
      right: 0;
      text-align: center;
    }
    .card-satellite img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .card-satellite .no-loc {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      color: var(--text-muted);
      font-size: 11px;
    }

    /* Clickable card header */
    .card-clickable {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      padding: 14px 18px 0;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }
    .card-clickable:hover .card-title { color: var(--accent-light); }
    .card-title-area { flex: 1; min-width: 0; }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.3;
      transition: color 0.15s;
    }
    .card-address {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .card-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .card-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }
    .card-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      transition: transform 0.25s ease, background 0.15s;
    }
    .card-toggle svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
    }
    .card.expanded .card-toggle {
      transform: rotate(180deg);
    }

    /* Summary row */
    .card-summary {
      display: flex;
      gap: 16px;
      padding: 10px 18px;
      font-size: 12px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }
    .card-summary strong {
      color: var(--text);
      font-weight: 600;
    }

    /* Collapsible project list */
    .card-projects {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .card.expanded .card-projects {
      max-height: 2000px;
    }

    /* Project rows */
    .project-row {
      display: flex;
      align-items: baseline;
      gap: 12px;
      padding: 8px 18px;
      font-size: 12px;
      border-top: 1px solid var(--border);
    }
    .project-row:first-child { border-top: none; }
    .project-type {
      font-weight: 500;
      min-width: 140px;
      flex-shrink: 0;
    }
    .project-budget {
      min-width: 90px;
      flex-shrink: 0;
      text-align: right;
      font-weight: 500;
    }
    .project-year {
      min-width: 40px;
      flex-shrink: 0;
      color: var(--text-muted);
    }
    .project-desc {
      flex: 1;
      min-width: 0;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Empty state */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      font-size: 15px;
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s;
    }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 600px) {
      .card-grid { grid-template-columns: 1fr; padding: 14px; }
      .filter-bar { padding: 10px 14px; }
      select, input[type="text"] { min-width: 120px; }
      .project-type { min-width: 100px; }
      .project-budget { min-width: 70px; }
      .project-desc { display: none; }
    }
  </style>
</head>
<body>
  <script>if(localStorage.getItem('paris-theme')==='dark')document.documentElement.setAttribute('data-theme','dark');</script>
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
  </div>

  <header>
    <div class="header-left">
      <h1>Travaux & <span>Équipements Publics</span> — Paris</h1>
      <nav>
        <a href="index.html">Carte</a>
        <a href="projects.html">Projets</a>
        <a href="buildings.html" class="active">Bâtiments</a>
      </nav>
    </div>
    <div class="header-right">
      <div class="record-count" id="recordCount">Chargement...</div>
      <button class="theme-toggle" id="themeToggle" title="Changer de thème">
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
    </div>
  </header>

  <div class="filter-bar">
    <div class="filter-item">
      <label>Catégorie</label>
      <select id="filterSecteur"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Type d'équipement</label>
      <select id="filterType"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Type de travaux</label>
      <select id="filterConstruction"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Arrondissement</label>
      <select id="filterArrond"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Service</label>
      <select id="filterService"><option value="">Tous</option></select>
    </div>
    <div class="filter-item">
      <label>Année</label>
      <select id="filterAnnee"><option value="">Toutes</option></select>
    </div>
    <div class="filter-item">
      <label>Recherche</label>
      <input type="text" id="filterSearch" placeholder="Nom, adresse...">
    </div>
    <button class="btn-reset" id="btnReset">Réinitialiser</button>
  </div>

  <div class="card-grid" id="cardGrid"></div>

  <script src="shared.js"></script>
  <script>
    let allRecords = [];
    let filteredRecords = [];

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function populateFilters() {
      const arrondissements = [...new Set(allRecords.map(r => r._arrondissement).filter(Boolean))]
        .sort((a, b) => parseInt(a) - parseInt(b));

      const sets = {
        filterSecteur: [...new Set(allRecords.map(r => r.secteur).filter(Boolean))].sort(),
        filterType: [...new Set(allRecords.map(r => r.type_equipement).filter(Boolean))].sort(),
        filterConstruction: [...new Set(allRecords.map(r => r._constructionGroup).filter(Boolean))].sort(),
        filterService: [...new Set(allRecords.map(r => r._service).filter(Boolean))].sort(),
        filterAnnee: [...new Set(allRecords.map(r => r.annee_livraison).filter(Boolean))].sort(),
        filterArrond: arrondissements,
      };

      for (const [id, values] of Object.entries(sets)) {
        const sel = document.getElementById(id);
        values.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
      }
      updateTypeOptions();
    }

    function updateTypeOptions() {
      const sel = document.getElementById('filterType');
      const current = sel.value;
      const secteur = document.getElementById('filterSecteur').value;

      let types;
      if (secteur) {
        types = [...new Set(allRecords.filter(r => r.secteur === secteur).map(r => r.type_equipement).filter(Boolean))].sort();
      } else {
        types = [...new Set(allRecords.map(r => r.type_equipement).filter(Boolean))].sort();
      }

      sel.innerHTML = '<option value="">Tous</option>';
      types.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });

      if (types.includes(current)) {
        sel.value = current;
      } else {
        sel.value = '';
      }
    }

    function groupBuildings(records) {
      const map = {};
      records.forEach(r => {
        const key = (r.equipement || '') + '|||' + (r.adresse || '');
        if (!map[key]) {
          map[key] = {
            name: r.equipement || '—',
            address: r.adresse || '—',
            arrondissement: r._arrondissement || '',
            projects: [],
            totalBudget: 0,
            sectorCounts: {},
            geo: null,
          };
        }
        const b = map[key];
        b.projects.push(r);
        if (r.budget) {
          const num = parseInt(r.budget.replace(/\s/g, ''), 10);
          if (!isNaN(num)) b.totalBudget += num;
        }
        const s = r.secteur || 'Autre';
        b.sectorCounts[s] = (b.sectorCounts[s] || 0) + 1;
        if (!b.geo && r.geo_point_2d) {
          b.geo = r.geo_point_2d;
        }
        if (!b.arrondissement && r._arrondissement) {
          b.arrondissement = r._arrondissement;
        }
      });

      const buildings = Object.values(map);
      // Compute dominant sector
      buildings.forEach(b => {
        let maxCount = 0;
        let dominant = 'Autre';
        for (const [sector, count] of Object.entries(b.sectorCounts)) {
          if (count > maxCount) {
            maxCount = count;
            dominant = sector;
          }
        }
        b.dominantSector = dominant;
      });
      // Sort by project count descending
      buildings.sort((a, b) => b.projects.length - a.projects.length);
      return buildings;
    }

    function renderBuildings() {
      const grid = document.getElementById('cardGrid');
      const buildings = groupBuildings(filteredRecords);

      if (buildings.length === 0) {
        grid.innerHTML = '<div class="empty-state">Aucun bâtiment ne correspond aux filtres sélectionnés.</div>';
        return;
      }

      const buildingSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M3 21V7l9-4 9 4v14H3zm2-2h5v-4h4v4h5V8.1l-7-3.12L5 8.1V19zm2-6h2v2H7v-2zm0-4h2v2H7V9zm4 4h2v2h-2v-2zm0-4h2v2h-2V9zm4 4h2v2h-2v-2zm0-4h2v2h-2V9z"/></svg>`;
      const chevronSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>`;

      grid.innerHTML = buildings.map((b, i) => {
        const color = getColor(b.dominantSector);
        const budgetStr = b.totalBudget > 0 ? b.totalBudget.toLocaleString('fr-FR') + ' €' : '—';
        const addrDisplay = escapeHtml(b.address) + (b.arrondissement ? ` (${b.arrondissement})` : '');
        const projCount = b.projects.length;
        const projLabel = projCount === 1 ? '1 projet' : `${projCount} projets`;

        const satUrl = b.geo ? getSatelliteUrl({ geo_point_2d: b.geo }) : null;
        const satHtml = satUrl
          ? `<img src="${satUrl}" alt="Vue satellite" loading="lazy">`
          : `<div class="no-loc">Pas de localisation</div>`;

        const projectRows = b.projects.map(r => {
          const pBudget = formatBudget(r);
          const pYear = r.annee_livraison || '—';
          const pType = escapeHtml(r._constructionGroup) || '—';
          const pDesc = escapeHtml(r.description) || '';
          return `<div class="project-row">
            <span class="project-type">${pType}</span>
            <span class="project-budget">${pBudget}</span>
            <span class="project-year">${pYear}</span>
            <span class="project-desc" title="${pDesc}">${pDesc}</span>
          </div>`;
        }).join('');

        return `
          <div class="card" data-index="${i}">
            <div class="card-images">
              <div class="card-placeholder" style="background:linear-gradient(135deg, ${color}, ${color}99)">
                ${buildingSvg}
                <span class="sector-label">${escapeHtml(b.dominantSector)}</span>
              </div>
              <div class="card-satellite">${satHtml}</div>
            </div>
            <div class="card-clickable" data-index="${i}">
              <div class="card-title-area">
                <div class="card-title">${escapeHtml(b.name)}</div>
                <div class="card-address">${addrDisplay}</div>
              </div>
              <div class="card-header-right">
                <span class="card-badge" style="background:${color}22;color:${color}">${escapeHtml(b.dominantSector)}</span>
                <span class="card-toggle">${chevronSvg}</span>
              </div>
            </div>
            <div class="card-summary">
              <span><strong>${projLabel}</strong></span>
              <span><strong>${budgetStr}</strong> budget total</span>
            </div>
            <div class="card-projects">${projectRows}</div>
          </div>
        `;
      }).join('');

      // Attach expand/collapse listeners
      grid.querySelectorAll('.card-clickable').forEach(el => {
        el.addEventListener('click', () => {
          el.closest('.card').classList.toggle('expanded');
        });
      });

      document.getElementById('recordCount').textContent =
        `${buildings.length} bâtiments \u00b7 ${filteredRecords.length} projets`;
    }

    function applyFilters() {
      const secteur = document.getElementById('filterSecteur').value;
      const type = document.getElementById('filterType').value;
      const construction = document.getElementById('filterConstruction').value;
      const service = document.getElementById('filterService').value;
      const annee = document.getElementById('filterAnnee').value;
      const arrond = document.getElementById('filterArrond').value;
      const search = document.getElementById('filterSearch').value.toLowerCase();

      filteredRecords = allRecords.filter(r => {
        if (secteur && r.secteur !== secteur) return false;
        if (type && r.type_equipement !== type) return false;
        if (construction && r._constructionGroup !== construction) return false;
        if (service && r._service !== service) return false;
        if (annee && r.annee_livraison !== annee) return false;
        if (arrond && r._arrondissement !== arrond) return false;
        if (search) {
          const hay = [r.equipement, r.adresse, r.description, r.type_equipement, r.secteur]
            .filter(Boolean).join(' ').toLowerCase();
          if (!hay.includes(search)) return false;
        }
        return true;
      });

      renderBuildings();
    }

    // Filter event listeners
    document.getElementById('filterSecteur').addEventListener('change', () => {
      updateTypeOptions();
      applyFilters();
    });
    ['filterType', 'filterConstruction', 'filterService', 'filterAnnee', 'filterArrond'].forEach(id => {
      document.getElementById(id).addEventListener('change', applyFilters);
    });
    document.getElementById('filterSearch').addEventListener('input', applyFilters);
    document.getElementById('btnReset').addEventListener('click', () => {
      ['filterSecteur', 'filterType', 'filterConstruction', 'filterService', 'filterAnnee', 'filterArrond'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('filterSearch').value = '';
      updateTypeOptions();
      applyFilters();
    });

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('paris-theme', 'light');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('paris-theme', 'dark');
      }
    });

    // Init
    (async () => {
      allRecords = await fetchAll();
      populateFilters();
      applyFilters();
      document.getElementById('loading').classList.add('hidden');
    })();
  </script>
</body>
</html>
